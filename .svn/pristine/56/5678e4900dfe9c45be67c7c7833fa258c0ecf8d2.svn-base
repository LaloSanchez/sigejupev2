<?php

include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/eliminarsolicitudes/EliminarsolicitudesDAO.Class.php");
/*
 * solicitud audiencia
 */
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/solicitudesaudiencias/SolicitudesaudienciasDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/solicitudesaudiencias/SolicitudesaudienciasDAO.Class.php");

/*
 * imputados
 */

include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/imputadossolicitudes/ImputadossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/imputadossolicitudes/ImputadossolicitudesDAO.Class.php");
//domicilios imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/domiciliosimputadossolicitudes/DomiciliosimputadossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/domiciliosimputadossolicitudes/DomiciliosimputadossolicitudesDAO.Class.php");
//telefonos imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/telefonosimputadossolicitudes/TelefonosimputadossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/telefonosimputadossolicitudes/TelefonosimputadossolicitudesDAO.Class.php");
//defensores imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/defensoresimputadossolicitudes/DefensoresimputadossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/defensoresimputadossolicitudes/DefensoresimputadossolicitudesDAO.Class.php");
//drogas imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/imputadosdrogas/ImputadosdrogasDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/imputadosdrogas/ImputadosdrogasDAO.Class.php");
//tutores imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/tutoresimputados/TutoresimputadosDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/tutoresimputados/TutoresimputadosDAO.Class.php");
//nacionalidades imputados
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/nacionalidadesimputadossolicitudes/NacionalidadesimputadossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/nacionalidadesimputadossolicitudes/NacionalidadesimputadossolicitudesDAO.Class.php");


/*
 * ofendidos solicitudes
 */

include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/ofendidossolicitudes/OfendidossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/ofendidossolicitudes/OfendidossolicitudesDAO.Class.php");
//domicilios ofendidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/domiciliosofendidossolicitudes/DomiciliosofendidossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/domiciliosofendidossolicitudes/DomiciliosofendidossolicitudesDAO.Class.php");
//telefonos ofnedidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/telefonosofendidossolicitudes/TelefonosofendidossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/telefonosofendidossolicitudes/TelefonosofendidossolicitudesDAO.Class.php");
//defensores ofendidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/defensoresofendidossolicitudes/DefensoresofendidossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/defensoresofendidossolicitudes/DefensoresofendidossolicitudesDAO.Class.php");
//tutores ofendidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/tutoresofendidos/TutoresofendidosDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/tutoresofendidos/TutoresofendidosDAO.Class.php");
//nacionalidades ofendidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/nacionalidadesofendidossolicitudes/NacionalidadesofendidossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/nacionalidadesofendidossolicitudes/NacionalidadesofendidossolicitudesDAO.Class.php");

/*
 * delitos
 */
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/delitossolicitudes/DelitossolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/delitossolicitudes/DelitossolicitudesDAO.Class.php");

/*
 * relacion impofedel solicitudes
 */
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/impofedelsolicitudes/ImpofedelsolicitudesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/impofedelsolicitudes/ImpofedelsolicitudesDAO.Class.php");
//efectos ofendidos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/efectosofendidos/EfectosofendidosDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/efectosofendidos/EfectosofendidosDAO.Class.php");
//violencia de genero
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/violenciadegenero/ViolenciadegeneroDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/violenciadegenero/ViolenciadegeneroDAO.Class.php");
//violencia factores sociales
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/violenciafactoressociales/ViolenciafactoressocialesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/violenciafactoressociales/ViolenciafactoressocialesDAO.Class.php");
//violencia homicidios dolosos
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/violenciahomicidiosdolosos/ViolenciahomicidiosdolososDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/violenciahomicidiosdolosos/ViolenciahomicidiosdolososDAO.Class.php");

//trata de personas
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/trataspersonas/TrataspersonasDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/trataspersonas/TrataspersonasDAO.Class.php");
//tabla sexuales
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/sexuales/SexualesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/sexuales/SexualesDAO.Class.php");
//testigos sexuales
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/testigossexuales/TestigossexualesDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/testigossexuales/TestigossexualesDAO.Class.php");
//sexuales conductas
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/sexualesconductas/SexualesconductasDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/sexualesconductas/SexualesconductasDAO.Class.php");
//detalles sexuales conductas
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dto/detallessexualesconductas/DetallessexualesconductasDTO.Class.php");
include_once(dirname(__FILE__) . "/../../../modelos/sigejupe/dao/detallessexualesconductas/DetallessexualesconductasDAO.Class.php");

date_default_timezone_set('America/Mexico_City');

class EliminarsolicitudController {

    private $proveedor;

    private function validarConsulta($solicitudAudienciaDto)
    {

        $estatus = 'ok';
        $mensajes = '';


        if ($solicitudAudienciaDto->fechaInicial == '' || $solicitudAudienciaDto->fechaFinal == '') {
            $estatus = 'error';
            $mensajes[] = '*Tienes que ingresar la fecha de inicio y fecha de fin.';
        }


        if ($solicitudAudienciaDto->fechaInicial > $solicitudAudienciaDto->fechaFinal) {
            $estatus = 'error';
            $mensajes[] = '*La fecha de inicio tiene que ser menor a la final.';
        }
        //validar que la fecha de fin sea al menos un mes menos a la fecha actual

        $fecha_actual_menos_un_mes = date('Y-m-d', strtotime('-1 month'));

        if ($solicitudAudienciaDto->fechaFinal > $fecha_actual_menos_un_mes) {
            $estatus = 'error';
            $mensajes[] = '*La fecha de fin tiene que ser de al menos un mes atrÃ¡s.';
        }


        return [
            'estatus' => $estatus,
            'mensaje' => $mensajes
        ];

    }

    private function validarEliminar($idSolicitudesAudiencia)
    {
        $estatus = 'ok';
        $mensajes = '';

        if (!count($idSolicitudesAudiencia)) {
            $estatus = 'error';
            $mensajes[] = '*Tienes que seleccionar al menos una solicitud de audiencia';
        }

        return [
            'estatus' => $estatus,
            'mensaje' => $mensajes
        ];
    }

    private function convertirFecha($fecha)
    {
        $date = str_replace('/', '-', $fecha);
        $fecha = date('Y-m-d', strtotime($date));

        return $fecha;
    }


    public function consultar($solicitudAudienciaDto)
    {
        $validaConsulta = $this->validarConsulta($solicitudAudienciaDto);

        if ($validaConsulta['estatus'] == 'error') return $validaConsulta;

        $eliminarSolicitudDao = new EliminarsolicitudesDAO();

        $solicitudAudienciaDto->fechaInicial = $this->convertirFecha($solicitudAudienciaDto->fechaInicial);
        $solicitudAudienciaDto->fechaFinal = $this->convertirFecha($solicitudAudienciaDto->fechaFinal);

        $selectSolicitudes = $eliminarSolicitudDao->selectSolicitudesSinAudiencia($solicitudAudienciaDto);

        if (count($selectSolicitudes['registros'])) {

            $ofendidoDto = new OfendidossolicitudesDTO();
            $ofendidoDao = new OfendidossolicitudesDAO();
            $imputadoDto = new ImputadossolicitudesDTO();
            $imputadoDao = new ImputadossolicitudesDAO();

            foreach ($selectSolicitudes['registros'] as $solicitud) {

                //establece los valores vacios de nuc y carpeta inv en ''
                if (is_null($solicitud->carpetaInv)) $solicitud->carpetaInv = '';
                if (is_null($solicitud->nuc)) $solicitud->nuc = '';

                $ofendidoDto->setIdSolicitudAudiencia($solicitud->idSolicitudAudiencia);
                $ofendidoDto->setActivo('S');

                $selectOfendido = $ofendidoDao->selectOfendidossolicitudes($ofendidoDto);

                $nombreOfendido = 'NA';

                if (count($selectOfendido)) {
                    $selectOfendido = $selectOfendido[0]->toString();

                    if ($selectOfendido['cveTipoPersona'] == 1) {
                        $nombreOfendido = $selectOfendido['nombre'] . ' ' . $selectOfendido['paterno'] . ' ' . $selectOfendido['materno'];
                    } else {
                        $nombreOfendido = $selectOfendido['nombreMoral'];
                    }

                }

                $imputadoDto->setIdSolicitudAudiencia($solicitud->idSolicitudAudiencia);
                $imputadoDto->setActivo('S');

                $selectImputado = $imputadoDao->selectImputadossolicitudes($imputadoDto);

                $nombreImputado = 'NA';

                if ($selectImputado != '') {
                    $selectImputado = $selectImputado[0]->toString();

                    if ($selectImputado['cveTipoPersona'] == 1) {
                        $nombreImputado = $selectImputado['nombre'] . ' ' . $selectImputado['paterno'] . ' ' . $selectImputado['materno'];
                    } else {
                        $nombreImputado = $selectImputado['nombreMoral'];
                    }


                }


                $solicitud->imputadoofendido = utf8_encode($nombreImputado) . ' / ' . $nombreOfendido;

            }

            $response = [
                'estatus' => 'ok',
                'mensaje' => 'resultados de la consulta',
                'total'   => $selectSolicitudes['total'],
                'pagina'  => $selectSolicitudes['pagina'],
                'data'    => $selectSolicitudes['registros']
            ];

        } else {

            $response = [
                'estatus' => 'error',
                'mensaje' => ['no se encontraron solicitudes de audiencia sin completar']
            ];

        }

        return $response;

    }

    /**
     * @param $idSolicitudesAudiencia
     * @param null $proveedor
     * @return array
     */
    public function eliminar($idSolicitudesAudiencia, $proveedor = null)
    {

        $validaEliminar = $this->validarEliminar($idSolicitudesAudiencia);

        if ($validaEliminar['estatus'] == 'error') return $validaEliminar;

        if ($proveedor == null) {

            $this->proveedor = new Proveedor('mysql', 'sigejupe');
            $this->proveedor->connect();

        } else {

            $this->proveedor = $proveedor;

        }


        try {


            $this->proveedor->execute("BEGIN");


            /*
             * @var TYPE_NAME $estatus
             * se cambia a activo = 'N'
             */
            $estatus = 'N';

            foreach ($idSolicitudesAudiencia as $idSolicitudAudiencia) {

                //eliminar solicitud audiencia = estatus activo = 'N' en la tabla tblsolicitudesaudiencias
                $solicitudesaudienciasDTO = new SolicitudesaudienciasDTO();
                $solicitudesaudienciasDTO->setIdSolicitudAudiencia($idSolicitudAudiencia);
                $solicitudesaudienciasDTO->setActivo($estatus);

                $solicitudesaudienciasDAO = new SolicitudesaudienciasDAO();
                $responseSolicitudAudiencia = $solicitudesaudienciasDAO->updateSolicitudesaudiencias($solicitudesaudienciasDTO, $this->proveedor);


                if ($responseSolicitudAudiencia == '') throw new Exception('no se pudo eliminar la solicitud de audiencia con id: ' . $idSolicitudAudiencia);

                //eliminar imputados con el id de solicitud de audiencia

                $imputadosDTO = new ImputadossolicitudesDTO();
                $imputadosDAO = new ImputadossolicitudesDAO();
                $imputadosDTO->setIdSolicitudAudiencia($idSolicitudAudiencia);
                $imputadosDTO->setActivo('S');
                $responseImputados = $imputadosDAO->selectImputadossolicitudes($imputadosDTO, '', $this->proveedor);

                if ($responseImputados != '') {

                    foreach ($responseImputados as $imputado) {

                        $idImputado = $imputado->getIdImputadoSolicitud();

                        $imputadoDto = new ImputadossolicitudesDTO();
                        $imputadoDto->setIdImputadoSolicitud($idImputado);
                        $imputadoDto->setActivo($estatus);

                        $imputadoDao = new ImputadossolicitudesDAO();
                        $eliminarImputado = $imputadoDao->eliminarImputadoByIdImputadoSolicitud($imputadoDto, '', $this->proveedor);

                        if (!$eliminarImputado) throw new Exception('no se pudo eliminar el imputado con el id: ' . $idImputado);

                        /*
                         * eliminar los domicilios de los imputados
                         */
                        $domiciliosImputadoDto = new DomiciliosimputadossolicitudesDTO();
                        $domiciliosImputadoDao = new DomiciliosimputadossolicitudesDAO();
                        $domiciliosImputadoDto->setIdImputadoSolicitud($idImputado);
                        $domiciliosImputadoDto->setActivo('S');
                        $selectDomiciliosImputado = $domiciliosImputadoDao->selectDomiciliosimputadossolicitudes($domiciliosImputadoDto, '', $this->proveedor);


                        if ($selectDomiciliosImputado != '') {

                            foreach ($selectDomiciliosImputado as $domicilioImputado) {
                                $idDomicilioImputado = $domicilioImputado->getIdDomicilioImputadoSolicitud();
                                $domiciliosImputadoDto->setIdDomicilioImputadoSolicitud($idDomicilioImputado);
                                $updateDomicilioImputado = $domiciliosImputadoDao->eliminaDomiciliosimputadossolicitudes($domiciliosImputadoDto, $this->proveedor);

                                if ($updateDomicilioImputado == '') throw new Exception('no se pudo eliminar el domicilio del imputado con el id: ' . $idDomicilioImputado);
                            }
                        }

                        /*
                         * eliminar telefonos de los imputados
                         */

                        $telefonosImputadosDto = new TelefonosimputadossolicitudesDTO();
                        $telefonosImputadosDao = new TelefonosimputadossolicitudesDAO();
                        $telefonosImputadosDto->setIdImputadoSolicitud($idImputado);
                        $telefonosImputadosDto->setActivo('S');
                        $selectTelefonosImputados = $telefonosImputadosDao->selectTelefonosimputadossolicitudes($telefonosImputadosDto, '', $this->proveedor);

                        if ($selectTelefonosImputados != '') {

                            foreach ($selectTelefonosImputados as $telefonoImputado) {
                                $idTelefonoImputado = $telefonoImputado->getIdTelefonoImputadosSolicitud();
                                $telefonosImputadosDto->setIdTelefonoImputadosSolicitud($idTelefonoImputado);
                                $updateTelefonoImputado = $telefonosImputadosDao->eliminaTelefonosimputadossolicitudes($telefonosImputadosDto, $this->proveedor);
                                if ($updateTelefonoImputado == '') throw new Exception('no se pudo eliminar el tel&eacute;fono del imputado con el id: ' . $idTelefonoImputado);
                            }

                        }

                        /*
                         * eliminar defnesores de imputados
                         */

                        $defensoresImputadosDto = new DefensoresimputadossolicitudesDTO();
                        $defensoresImputadosDao = new DefensoresimputadossolicitudesDAO();
                        $defensoresImputadosDto->setIdImputadoSolicitud($idImputado);
                        $defensoresImputadosDto->setActivo('S');

                        $selectDefensoresImputados = $defensoresImputadosDao->selectDefensoresimputadossolicitudes($defensoresImputadosDto, '', $this->proveedor);

                        if ($selectDefensoresImputados != '') {
                            foreach ($selectDefensoresImputados as $defensorImputado) {

                                $idDefensorImputado = $defensorImputado->getIdDefensorImputadoSolicitud();
                                $defensoresImputadosDto->setIdDefensorImputadoSolicitud($idDefensorImputado);
                                $updateDefensorImputado = $defensoresImputadosDao->eliminaDefensoresimputadossolicitudes($defensoresImputadosDto, $this->proveedor);

                                if ($updateDefensorImputado == '') throw new Exception('no se pudo eliminar el defensor del imputado con el id: ' . $idDefensorImputado);

                            }
                        }

                        /*
                         * eliminar drogas de imputados
                         */

                        $drogasImputadosDto = new ImputadosdrogasDTO();
                        $drogasImputadosDao = new ImputadosdrogasDAO();
                        $drogasImputadosDto->setIdImputadoSolicitud($idImputado);
                        $drogasImputadosDto->setActivo('S');
                        $selectDrogasImputados = $drogasImputadosDao->selectImputadosdrogas($drogasImputadosDto, '', $this->proveedor);

                        if ($selectDrogasImputados != '') {
                            foreach ($selectDrogasImputados as $drogaImputado) {
                                $idDrogaImputado = $drogaImputado->getIdImputadoDroga();
                                $drogasImputadosDto->setIdImputadoDroga($idDrogaImputado);
                                $drogasImputadosDto->setActivo($estatus);
                                $updateDrogaImputado = $drogasImputadosDao->updateImputadosdrogas($drogasImputadosDto, $this->proveedor);

                                if ($updateDrogaImputado == '') throw new Exception('no se pudo eliminar la droga del imputado con el id: ' . $idDrogaImputado);
                            }
                        }


                        /*
                         * eliminar tutores / representantes de imputados
                         */

                        $tutoresImputadosDto = new TutoresimputadosDTO();
                        $tutoresImputadosDao = new TutoresimputadosDAO();
                        $tutoresImputadosDto->setIdImputadoSolicitud($idImputado);
                        $tutoresImputadosDto->setActivo('S');
                        $selectTutoresImputados = $tutoresImputadosDao->selectTutoresimputados($tutoresImputadosDto, '', $this->proveedor);

                        if ($selectTutoresImputados != '') {

                            foreach ($selectTutoresImputados as $tutorImputado) {
                                $idTutorImputado = $tutorImputado->getIdTutorImputado();
                                $tutoresImputadosDto->setIdTutorImputado($idTutorImputado);
                                $tutoresImputadosDto->setActivo($estatus);
                                $updateTutorImputado = $tutoresImputadosDao->eliminaTutoresimputados($tutoresImputadosDto, $this->proveedor);

                                if ($updateTutorImputado == '') throw new Exception('no se pudo eliminar el tutor del imputado con el id: ' . $idTutorImputado);
                            }

                        }

                        /*
                         * eliminar nacionalidades de imputados
                         */

                        $nacionalidadesImputadosDto = new NacionalidadesimputadossolicitudesDTO();
                        $nacionalidadesImputadosDao = new NacionalidadesimputadossolicitudesDAO();
                        $nacionalidadesImputadosDto->setIdImputadoSolicitud($idImputado);
                        $nacionalidadesImputadosDto->setActivo('S');

                        $selectNacionalidadesImputados = $nacionalidadesImputadosDao->selectNacionalidadesimputadossolicitudes($nacionalidadesImputadosDto, '', $this->proveedor);

                        if ($selectNacionalidadesImputados != '') {

                            foreach ($selectNacionalidadesImputados as $nacionalidadImputado) {
                                $idNacionalidadImputado = $nacionalidadImputado->getIdNacionalidadImputadoSolicitud();
                                $nacionalidadesImputadosDto->setIdNacionalidadImputadoSolicitud($idNacionalidadImputado);
                                $nacionalidadesImputadosDto->setActivo($estatus);
                                $updateNacionalidadImputado = $nacionalidadesImputadosDao->updateNacionalidadesimputadossolicitudes($nacionalidadesImputadosDto);

                                if ($updateNacionalidadImputado == '') throw new Exception('no se pudo eliminar la nacionalidad del imputado con el id: ' . $idNacionalidadImputado);
                            }
                        }

                    }


                }


                /*
                 * eliminar ofendidos y sus relaciones
                 */

                $ofendidosDto = new OfendidossolicitudesDTO();
                $ofendidosDao = new OfendidossolicitudesDAO();
                $ofendidosDto->setIdSolicitudAudiencia($idSolicitudAudiencia);
                $ofendidosDto->setActivo('S');
                $selectOfendidos = $ofendidosDao->selectOfendidossolicitudes($ofendidosDto, '', $this->proveedor);

                if (count($selectOfendidos)) {

                    foreach ($selectOfendidos as $ofendido) {
                        //eliminar el ofendido
                        $idOfendido = $ofendido->getIdOfendidoSolicitud();
                        $ofendidosDto->setIdOfendidoSolicitud($idOfendido);
                        $ofendidosDto->setActivo($estatus);
                        $ofendidosResponse = $ofendidosDao->updateOfendidossolicitudes($ofendidosDto, $this->proveedor);
                        if (!count($ofendidosResponse)) throw new Exception('no se pudo eliminar el ofendido con el id: ' . $idOfendido);


                        //eliminar domicilios del ofendido
                        $domicilioDao = new DomiciliosofendidossolicitudesDAO();
                        $domicilioDto = new DomiciliosofendidossolicitudesDTO();
                        $domicilioDto->setIdOfendidoSolicitud($idOfendido);
                        $domicilioResponse = $domicilioDao->eliminarDomicilioOfendido($domicilioDto, $this->proveedor);
                        if (!$domicilioResponse) throw new Exception('domicilios del ofendido con id: ' . $idOfendido . ' no se pudieron eliminar');


                        //eliminar telÃ©fonos
                        $telefonoDao = new TelefonosofendidossolicitudesDAO();
                        $telefonoDto = new TelefonosofendidossolicitudesDTO();
                        $telefonoDto->setIdOfendidoSolicitud($idOfendido);
                        $telefonoResponse = $telefonoDao->eliminarTelefonosOfendido($telefonoDto, $this->proveedor);
                        if (!$telefonoResponse) throw new Exception('telÃ©fonos del ofendido con id: ' . $idOfendido . ' no se pudieron eliminar');


                        //eliminar defensores
                        $defensorDao = new DefensoresofendidossolicitudesDAO();
                        $defensorDto = new DefensoresofendidossolicitudesDTO();
                        $defensorDto->setIdOfendidoSolicitud($idOfendido);
                        $defensorResponse = $defensorDao->eliminarDefensoresOfendido($defensorDto, $this->proveedor);
                        if (!$defensorResponse) throw new Exception('defensores del ofendido con id: ' . $idOfendido . ' no se pudieron eliminar');


                        //eliminar tutores
                        $tutorDao = new TutoresofendidosDAO();
                        $tutorDto = new TutoresofendidosDTO();
                        $tutorDto->setIdOfendidoSolicitud($idOfendido);
                        $tutorResponse = $tutorDao->eliminarTutoresOfendido($tutorDto, $this->proveedor);
                        if (!$tutorResponse) throw new Exception('tutores del ofendido con id: ' . $idOfendido . ' no se pudieron eliminar');

                        //eliminar las nacionalidades del ofendido
                        $nacionalidadDao = new NacionalidadesofendidossolicitudesDAO();
                        $nacionalidadDto = new NacionalidadesofendidossolicitudesDTO();
                        $nacionalidadDto->setIdOfendidoSolicitud($idOfendido);
                        $nacionalidadResponse = $nacionalidadDao->eliminarNacionalidadesOfendidos($nacionalidadDto, $this->proveedor);
                        if (!$nacionalidadResponse) throw new Exception('nacionalidades del ofendido con id: ' . $idOfendido . ' no se pudieron eliminar');

                    }

                }


                /*
                 * eliminar delitos
                 */
                $delitosDto = new DelitossolicitudesDTO();
                $delitosDao = new DelitossolicitudesDAO();
                $delitosDto->setActivo('S');
                $delitosDto->setIdSolicitudAudiencia($idSolicitudAudiencia);
                $selectDelitos = $delitosDao->selectDelitossolicitudes($delitosDto, '', $this->proveedor);

                if ($selectDelitos != '') {

                    foreach ($selectDelitos as $delito) {
                        $idDelito = $delito->getIdDelitoSolicitud();
                        $delitosDto->setIdDelitoSolicitud($idDelito);
                        $delitosDto->setActivo($estatus);

                        $updateDelito = $delitosDao->updateDelitossolicitudes($delitosDto, $this->proveedor);

                        if ($updateDelito == '') throw new Exception('no se pudo eliminar el delito con id : ' . $idDelito);
                    }

                }


                /*
                 * eliminar la relacion
                 */
                $relacionDto = new ImpofedelsolicitudesDTO();
                $relacionDao = new ImpofedelsolicitudesDAO();

                $relacionDto->setIdSolicitudAudiencia($idSolicitudAudiencia);
                $relacionDto->setActivo('S');

                $selectRelacion = $relacionDao->selectImpofedelsolicitudes($relacionDto, '', $this->proveedor);

                if ($selectRelacion != '') {

                    foreach ($selectRelacion as $relacion) {

                        $idImpOFeDel = $relacion->getIdImpOfeDelSolicitud();
                        //eliminar la relacion
                        $relacionDto->setIdImpOfeDelSolicitud($idImpOFeDel);
                        $relacionDto->setActivo($estatus);
                        $updateImpOfeDel = $relacionDao->updateImpofedelsolicitudes($relacionDto, $this->proveedor);
                        if ($updateImpOfeDel == '') throw new Exception('no se pudo eliminar la relacion con el id: ' . $idImpOFeDel);

                        //eliminar efectosofendidos
                        $efectosOfendidosDto = new EfectosofendidosDTO();
                        $efectosOfendidosDao = new EfectosofendidosDAO();
                        $efectosOfendidosDto->setIdImpOfeDelSolicitud($idImpOFeDel);
                        $efectosOfendidosDto->setActivo('S');
                        $selectEfectosOfendidos = $efectosOfendidosDao->selectEfectosofendidos($efectosOfendidosDto, '', $this->proveedor);

                        if ($selectEfectosOfendidos != '') {
                            foreach ($selectEfectosOfendidos as $efectoOfendido) {
                                $idEfectoOfendido = $efectoOfendido->getIdEfectoOfendido();
                                $efectosOfendidosDto->setIdEfectoOfendido($idEfectoOfendido);
                                $efectosOfendidosDto->setActivo($estatus);

                                $updateEfectoOfendido = $efectosOfendidosDao->updateEfectosofendidos($efectosOfendidosDto, $this->proveedor);
                                if ($updateEfectoOfendido == '') throw new Exception('no se pudo eliminar el efecto ofendido con el id: ' . $idEfectoOfendido);
                            }
                        }

                        //eliminar violencia de genero
                        $violenciaGeneroDto = new ViolenciadegeneroDTO();
                        $violenciaGeneroDao = new ViolenciadegeneroDAO();
                        $violenciaGeneroDto->setIdImpOfeDelSolicitud($idImpOFeDel);
                        $violenciaGeneroDto->setActivo('S');
                        $selectViolenciaGenero = $violenciaGeneroDao->selectViolenciadegenero($violenciaGeneroDto, '', $this->proveedor);

                        if ($selectViolenciaGenero != '') {

                            foreach ($selectViolenciaGenero as $violenciaGenero) {
                                $idViolenciaGenero = $violenciaGenero->getIdViolenciaDeGenero();
                                //eliminar cada registro violencia de genero;

                                $violenciaGeneroDto->setIdViolenciaDeGenero($idViolenciaGenero);
                                $violenciaGeneroDto->setActivo($estatus);

                                $updateViolenciaGenero = $violenciaGeneroDao->updateViolenciadegenero($violenciaGeneroDto, $this->proveedor);

                                if ($updateViolenciaGenero == '') throw new Exception('no se pudo eliminar el registro violencia de genero con el id: ' . $idViolenciaGenero);

                                //eliminar violencia factores sociales
                                $violenciaFactoresSocialesDto = new ViolenciafactoressocialesDTO();
                                $violenciaFactoresSocialesDao = new ViolenciafactoressocialesDAO();
                                $violenciaFactoresSocialesDto->setIdViolenciaDeGenero($idViolenciaGenero);
                                $violenciaFactoresSocialesDto->setActivo('S');

                                $selectViolenciaFactoresSociales = $violenciaFactoresSocialesDao->selectViolenciafactoressociales($violenciaFactoresSocialesDto, '', $this->proveedor);

                                if ($selectViolenciaFactoresSociales != '') {
                                    foreach ($selectViolenciaFactoresSociales as $violenciaFactorSocial) {
                                        $idViolenciaFactorSocial = $violenciaFactorSocial->getIdViolenciaFactorSocial();
                                        $violenciaFactoresSocialesDto->setIdViolenciaFactorSocial($idViolenciaFactorSocial);
                                        $violenciaFactoresSocialesDto->setActivo($estatus);

                                        $updateViolenciaFactorSocial = $violenciaFactoresSocialesDao->updateViolenciafactoressociales($violenciaFactoresSocialesDto, $this->proveedor);

                                        if ($updateViolenciaFactorSocial == '') throw new Exception('no se pudo eliminar el registro violencia factor social con id: ' . $idViolenciaFactorSocial);
                                    }
                                }


                                //eliminar violencia homicidios dolosos
                                $violenciaHomicidiosDolososDto = new ViolenciahomicidiosdolososDTO();
                                $violenciaHomicidiosDolososDao = new ViolenciahomicidiosdolososDAO();
                                $violenciaHomicidiosDolososDto->setIdViolenciaDeGenero($idViolenciaGenero);
                                $violenciaHomicidiosDolososDto->setActivo('S');

                                $selectViolenciaHomicidiosDolosos = $violenciaHomicidiosDolososDao->selectViolenciahomicidiosdolosos($violenciaHomicidiosDolososDto, '', $this->proveedor);

                                if ($selectViolenciaHomicidiosDolosos != '') {
                                    foreach ($selectViolenciaHomicidiosDolosos as $violenciaHomicidioDoloso) {
                                        $idViolenciaHomicidioDoloso = $violenciaHomicidioDoloso->getIdViolenciaHomicidioDoloso();
                                        $violenciaHomicidiosDolososDto->setIdViolenciaHomicidioDoloso($idViolenciaHomicidioDoloso);
                                        $violenciaHomicidiosDolososDto->setActivo($estatus);

                                        $updateViolenciaHomicidioDoloso = $violenciaHomicidiosDolososDao->updateViolenciahomicidiosdolosos($violenciaHomicidiosDolososDto, $this->proveedor);

                                        if ($updateViolenciaHomicidioDoloso == '') throw new Exception('no se pudo eliminar el registro violencia homicidio doloso con id: ' . $idViolenciaHomicidioDoloso);
                                    }
                                }

                            }


                        }


                        //eliminar trata de personas
                        $trataPersonasDto = new TrataspersonasDTO();
                        $trataPersonasDao = new TrataspersonasDAO();
                        $trataPersonasDto->setIdImpOfeDelSolicitud($idImpOFeDel);
                        $trataPersonasDto->setActivo('S');

                        $selectTratasPersonas = $trataPersonasDao->selectTrataspersonas($trataPersonasDto, '', $this->proveedor);

                        if ($selectTratasPersonas != '') {

                            foreach ($selectTratasPersonas as $trataPersona) {
                                $idTrataPersona = $trataPersona->getIdTrataPersona();

                                $trataPersonasDto->setIdTrataPersona($idTrataPersona);
                                $trataPersonasDto->setActivo($estatus);

                                $updateTrataPersona = $trataPersonasDao->updateTrataspersonas($trataPersonasDto, $this->proveedor);

                                if ($updateTrataPersona == '') throw new Exception('no se pudo eliminar el registro trata de personas con el id: ' . $idTrataPersona);
                            }

                        }

                        //eliminar sexuales

                        $sexualesDto = new SexualesDTO();
                        $sexualesDao = new SexualesDAO();

                        $sexualesDto->setIdImpOfeDelSolicitud($idImpOFeDel);
                        $sexualesDto->setActivo('S');

                        $selectSexuales = $sexualesDao->selectSexuales($sexualesDto);

                        if ($selectSexuales != '') {
                            foreach ($selectSexuales as $sexual) {
                                $idSexual = $sexual->getIdSexual();
                                $sexualesDto->setIdSexual($idSexual);
                                $sexualesDto->setActivo($estatus);

                                $updateSexual = $sexualesDao->updateSexuales($sexualesDto);

                                if ($updateSexual == '') throw new Exception('No se pudo eliminar el registro en la tabla sexuales con el id: ' . $idSexual);

                                //eliminar testigos sexuales
                                $testigosSexualesDto = new TestigossexualesDTO();
                                $testigosSexualesDao = new TestigossexualesDAO();
                                $testigosSexualesDto->setIdSexual($idSexual);
                                $testigosSexualesDto->setActivo('S');

                                $selectTestigosSexuales = $testigosSexualesDao->selectTestigossexuales($testigosSexualesDto, '', $this->proveedor);

                                if ($selectTestigosSexuales != '') {

                                    foreach ($selectTestigosSexuales as $testigoSexual) {
                                        $idTestigoSexual = $testigoSexual->getIdTestigoSexual();

                                        $testigosSexualesDto->setIdTestigoSexual($idTestigoSexual);
                                        $testigosSexualesDto->setActivo($estatus);

                                        $updateTestigoSexual = $testigosSexualesDao->updateTestigossexuales($testigosSexualesDto, $this->proveedor);

                                        if ($updateTestigoSexual == '') throw New Exception('no se pudo eliminar el testigo sexual con el id: ' . $idTestigoSexual);

                                    }

                                }


                                //eliminar sexualesconductas

                                $sexualesConductasDto = new SexualesconductasDTO();
                                $sexualesConductasDao = new SexualesconductasDAO();

                                $sexualesConductasDto->setIdSexual($idSexual);
                                $sexualesConductasDto->setActivo('S');

                                $selectSexualesConductas = $sexualesConductasDao->selectSexualesconductas($sexualesConductasDto, '', $this->proveedor);

                                if ($selectSexualesConductas != '') {

                                    foreach ($selectSexualesConductas as $sexualConducta) {
                                        $idSexualConducta = $sexualConducta->getIdSexualConducta();
                                        $sexualesConductasDto->setIdSexualConducta($idSexualConducta);
                                        $sexualesConductasDto->setActivo($estatus);

                                        $updateSexualConducta = $sexualesConductasDao->updateSexualesconductas($sexualesConductasDto, $this->proveedor);

                                        if ($updateSexualConducta == '') throw new Exception('no se pudo eliminar el registro sexual conducta con id: ' . $idSexualConducta);


                                        //eliminar detalles sexuales conductas
                                        $detallesSexualesConductasDto = new DetallessexualesconductasDTO();
                                        $detallesSexualesConductasDao = new DetallessexualesconductasDAO();

                                        $detallesSexualesConductasDto->setIdSexualConducta($idSexualConducta);
                                        $detallesSexualesConductasDto->setActivo('S');

                                        $selectDetallesSexualesConductas = $detallesSexualesConductasDao->selectDetallessexualesconductas($detallesSexualesConductasDto, '', $this->proveedor);

                                        if ($selectDetallesSexualesConductas != '') {
                                            foreach ($selectDetallesSexualesConductas as $detalleSexualConducta) {
                                                $idDetalleSexualConducta = $detalleSexualConducta->getIdDetalleSexualConducta();

                                                $detallesSexualesConductasDto->setIdDetalleSexualConducta($idDetalleSexualConducta);
                                                $detallesSexualesConductasDto->setActivo($estatus);

                                                $updateDetalleSexualConducta = $detallesSexualesConductasDao->updateDetallessexualesconductas($detallesSexualesConductasDto, $this->proveedor);

                                                if ($updateDetalleSexualConducta == '') throw new Exception('no se pudo eliminar el detalle sexual conducta con id: ' . $idDetalleSexualConducta);
                                            }
                                        }

                                    }


                                }

                            }
                        }


                    }

                }


            }

            $this->proveedor->execute("COMMIT");

            $response = [
                'estatus' => 'ok',
                'mensaje' => 'Solicitud(es) eliminadas correctamente'
            ];

        } catch (Exception $e) {

            $this->proveedor->execute("ROLLBACK");

            $response = [
                'estatus' => 'error',
                'mensaje' => [$e->getMessage()]
            ];
        }

        return $response;


    }


}